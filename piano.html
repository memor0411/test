<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>가상 피아노</title>
<style>
  body {
    background: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: white;
    font-family: sans-serif;
  }
  .controls { margin-bottom: 20px; }
  button {
    margin: 4px; padding: 8px 12px; border: none; border-radius: 6px;
    cursor: pointer; background: #555; color: white;
  }
  button.active { background: #2ecc71; }
  .piano { position: relative; display: flex; }
  .white {
    width: 60px; height: 240px; background: white; border: 1px solid #000;
    z-index: 1; box-shadow: inset -2px 0 3px rgba(0,0,0,0.3);
  }
  .black {
    width: 40px; height: 150px; background: black; position: absolute;
    top: 0; z-index: 2; margin-left: -20px; border: 1px solid #111;
  }
  .key:active, .key.playing { background: #ddd; }
  .black.playing { background: #333; }
  .note-label {
    position: absolute; left: 50%; bottom: 6px;
    transform: translateX(-50%); font-size: 12px; color: #333;
  }
</style>
</head>
<body>

  <div class="controls">
    <button id="startAudio">피아노 시작하기</button>
  </div>

  <div class="piano" id="piano"></div>

<script>
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let isStarted = false;

const BASE_URL = "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_grand_piano-mp3/";
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const OCTAVES = [4,5];
const audioBuffers = {};

function noteToFile(note) {
  return note.replace('#', 's');
}

async function loadNote(note, octave) {
  const key = note + octave;
  if (audioBuffers[key]) return;
  const url = `${BASE_URL}${noteToFile(note)}${octave}.mp3`;
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    const buf = await audioCtx.decodeAudioData(arr);
    audioBuffers[key] = buf;
    console.log("로드 성공:", key);
  } catch (err) {
    console.error("로드 실패:", key, url);
  }
}

async function preload() {
  const promises = [];
  for (let o of OCTAVES) {
    for (let n of NOTES) promises.push(loadNote(n, o));
  }
  // 다음 옥타브의 C도 로드 (C6)
  promises.push(loadNote('C', 6));
  await Promise.all(promises);
  console.log("모든 음 로드 완료");
}

/* 완전 새로 짠 코드 계산 로직 */
function getChordNotes(rootNote, rootOctave) {
  const idx = NOTES.indexOf(rootNote);
  if (idx < 0) return [{note: rootNote, octave: rootOctave}];

  const intervals = [0, 4, 7]; // root, major 3rd, perfect 5th
  const result = [];

  for (let intv of intervals) {
    const noteIdx = (idx + intv) % 12;
    const octaveShift = Math.floor((idx + intv) / 12);
    const note = NOTES[noteIdx];
    const octave = rootOctave + octaveShift;
    result.push({note, octave});
  }

  return result;
}

function playChord(rootNote, rootOctave) {
  const chord = getChordNotes(rootNote, rootOctave);
  chord.forEach(n => {
    const key = n.note + n.octave;
    const buffer = audioBuffers[key];
    if (buffer) {
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(audioCtx.destination);
      src.start();
    } else {
      console.warn("음원 없음:", key);
    }
  });
}

function createPiano() {
  const piano = document.getElementById("piano");
  piano.innerHTML = "";
  const whiteNotes = ['C','D','E','F','G','A','B'];
  const blackPattern = ['C#','D#',null,'F#','G#','A#',null];

  const whiteKeys = [];
  for (let o = 4; o <= 5; o++) {
    for (const wn of whiteNotes) whiteKeys.push({note: wn, octave: o});
  }
  whiteKeys.push({note: 'C', octave: 6});

  piano.style.display = 'block';
  piano.style.width = (whiteKeys.length * 60) + 'px';
  piano.style.height = '240px';
  piano.style.position = 'relative';

  // white
  whiteKeys.forEach((k, i) => {
    const w = document.createElement('div');
    w.classList.add('key', 'white');
    w.style.position = 'absolute';
    w.style.left = (i * 60) + 'px';
    w.dataset.note = k.note;
    w.dataset.octave = k.octave;
    w.innerHTML = `<div class="note-label">${k.note}${k.octave}</div>`;
    w.addEventListener('mousedown', () => {
      w.classList.add('playing');
      playChord(k.note, k.octave);
    });
    w.addEventListener('mouseup', () => w.classList.remove('playing'));
    w.addEventListener('mouseleave', () => w.classList.remove('playing'));
    piano.appendChild(w);
  });

  // black
  for (let oIndex = 0; oIndex < 2; oIndex++) {
    const baseOctave = 4 + oIndex;
    for (let i = 0; i < blackPattern.length; i++) {
      const bn = blackPattern[i];
      if (!bn) continue;
      const whiteIndex = oIndex * 7 + i;
      const left = (whiteIndex * 60) + 45;
      const b = document.createElement('div');
      b.classList.add('key', 'black');
      b.style.position = 'absolute';
      b.style.left = left + 'px';
      b.dataset.note = bn;
      b.dataset.octave = baseOctave;
      b.innerHTML = `<div class="note-label">${bn}${baseOctave}</div>`;
      b.addEventListener('mousedown', () => {
        b.classList.add('playing');
        playChord(bn, baseOctave);
      });
      b.addEventListener('mouseup', () => b.classList.remove('playing'));
      b.addEventListener('mouseleave', () => b.classList.remove('playing'));
      piano.appendChild(b);
    }
  }
}

document.getElementById("startAudio").addEventListener("click", async () => {
  if (!isStarted) {
    audioCtx = new AudioContext();
    isStarted = true;
    await preload();
    alert("피아노가 준비되었습니다!");
  }
});

createPiano();
</script>
</body>
</html>
