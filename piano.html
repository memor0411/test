<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>가상 피아노</title>
<style>
  body {
    background: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: white;
    font-family: sans-serif;
  }

  .controls {
    margin-bottom: 20px;
  }

  button {
    margin: 4px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #555;
    color: white;
  }

  button.active {
    background: #2ecc71;
  }

  .piano {
    position: relative;
    display: flex;
  }

  .white {
    width: 60px;
    height: 240px;
    background: white;
    border: 1px solid #000;
    z-index: 1;
    box-shadow: inset -2px 0 3px rgba(0,0,0,0.3);
  }

  .black {
    width: 40px;
    height: 150px;
    background: black;
    position: absolute;
    top: 0;
    z-index: 2;
    margin-left: -20px;
    border: 1px solid #111;
  }

  .key:active, .key.playing {
    background: #ddd;
  }

  .black.playing {
    background: #333;
  }

</style>
</head>
<body>

  <div class="controls">
    <button id="startAudio">피아노 시작하기</button>
    <button id="majorBtn" class="active">장조</button>
    <button id="minorBtn">단조</button>
    <button id="code1Btn" class="active">코드 1</button>
    <button id="code2Btn">코드 2</button>
  </div>

  <div class="piano" id="piano"></div>

<script>
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let isStarted = false;
let scaleType = 'major';
let codeType = 1;

const BASE_URL = "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_grand_piano-mp3/";
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const OCTAVES = [4,5];

const audioBuffers = {};

function noteToFile(note) {
  return note.replace('#', 's');
}

async function loadNote(note, octave) {
  const key = note + octave;
  if (audioBuffers[key]) return;
  const url = `${BASE_URL}${noteToFile(note)}${octave}.mp3`;
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    const buf = await audioCtx.decodeAudioData(arr);
    audioBuffers[key] = buf;
    console.log("로드 성공:", key);
  } catch (err) {
    console.error("로드 실패:", key, url);
  }
}

async function preload() {
  const promises = [];
  for (let o of OCTAVES) {
    for (let n of NOTES) {
      promises.push(loadNote(n, o));
    }
  }
  await Promise.all(promises);
  console.log("모든 음 로드 완료");
}

function playChord(note) {
  const idx = NOTES.indexOf(note);
  if (idx < 0) return;

  // 코드 구조
  const major = [0, 4, 7];
  const minor = [0, 3, 7];
  const pattern = scaleType === 'major' ? major : minor;

  pattern.forEach(interval => {
    let noteIndex = (idx + interval) % NOTES.length;
    let octaveShift = Math.floor((idx + interval) / NOTES.length);
    let octave = 4 + octaveShift;
    const noteName = NOTES[noteIndex];
    const key = noteName + octave;
    if (audioBuffers[key]) {
      const src = audioCtx.createBufferSource();
      src.buffer = audioBuffers[key];
      src.connect(audioCtx.destination);
      src.start();
    } else {
      console.warn("음원 없음:", key);
    }
  });
}

function createPiano() {
  const piano = document.getElementById("piano");
  let whiteIndex = 0;
  NOTES.forEach((note, i) => {
    const key = document.createElement("div");
    key.classList.add("key");
    const isBlack = note.includes("#");
    key.classList.add(isBlack ? "black" : "white");
    key.dataset.note = note;
    key.dataset.octave = 4;
    if (isBlack) {
      key.style.left = `${whiteIndex * 60 + 45}px`;
    } else {
      key.style.left = `${whiteIndex * 60}px`;
      whiteIndex++;
    }
    key.addEventListener('mousedown', () => {
      key.classList.add("playing");
      playChord(note);
    });
    key.addEventListener('mouseup', () => key.classList.remove("playing"));
    key.addEventListener('mouseleave', () => key.classList.remove("playing"));
    piano.appendChild(key);
  });
}

document.getElementById("startAudio").addEventListener("click", async () => {
  if (!isStarted) {
    audioCtx = new AudioContext();
    isStarted = true;
    await preload();
    alert("피아노가 준비되었습니다!");
  }
});

document.getElementById("majorBtn").addEventListener("click", () => {
  scaleType = 'major';
  document.getElementById("majorBtn").classList.add("active");
  document.getElementById("minorBtn").classList.remove("active");
});

document.getElementById("minorBtn").addEventListener("click", () => {
  scaleType = 'minor';
  document.getElementById("minorBtn").classList.add("active");
  document.getElementById("majorBtn").classList.remove("active");
});

document.getElementById("code1Btn").addEventListener("click", () => {
  codeType = 1;
  document.getElementById("code1Btn").classList.add("active");
  document.getElementById("code2Btn").classList.remove("active");
});

document.getElementById("code2Btn").addEventListener("click", () => {
  codeType = 2;
  document.getElementById("code2Btn").classList.add("active");
  document.getElementById("code1Btn").classList.remove("active");
});

createPiano();
</script>
</body>
</html>
