<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¹ ê°€ìƒ í”¼ì•„ë…¸</title>
  <style>
    body {
      background: #222;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      user-select: none;
    }
    h1 { margin-bottom: 10px; }
    #startButton {
      padding: 10px 20px;
      background: #4caf50;
      color: white;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #startButton:hover { background: #66bb6a; }

    .controls {
      display: none;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      justify-content: center;
      align-items: center;
    }
    select, button {
      padding: 6px 10px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    button.active { background: #4caf50; color: white; }

    .piano {
      display: none;
      position: relative;
      height: 250px;
    }
    .white-key {
      width: 60px;
      height: 250px;
      background: white;
      border: 1px solid #000;
      box-shadow: inset -2px 0 3px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1;
      position: relative;
    }
    .black-key {
      position: absolute;
      width: 40px;
      height: 160px;
      background: black;
      border: 1px solid #000;
      margin-left: -20px;
      z-index: 2;
      box-shadow: inset -2px 0 3px rgba(255,255,255,0.1);
      cursor: pointer;
    }

    .highlight-root { box-shadow: 0 0 12px 4px rgba(255,200,0,0.8); }
    .highlight-chord { box-shadow: 0 0 8px 3px rgba(100,200,255,0.7); }
  </style>
</head>
<body>

  <h1>ğŸ¹ ê°€ìƒ í”¼ì•„ë…¸</h1>
  <button id="startButton">ğŸµ í”¼ì•„ë…¸ ì‹œì‘í•˜ê¸°</button>

  <div class="controls" id="controls">
    <label>ì˜¥íƒ€ë¸Œ:</label>
    <select id="octaveSelect">
      <option value="2">2 ì˜¥íƒ€ë¸Œ</option>
      <option value="3">3 ì˜¥íƒ€ë¸Œ</option>
    </select>

    <label>ì¡°ì„±:</label>
    <select id="keySelect">
      <option value="C">C</option>
      <option value="D">D</option>
      <option value="E">E</option>
      <option value="F">F</option>
      <option value="G">G</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>

    <label>ìŒê³„:</label>
    <button id="scaleMajor" class="active">ì¥ì¡°</button>
    <button id="scaleMinor">ë‹¨ì¡°</button>

    <label>ì½”ë“œ:</label>
    <button id="modeDiatonic" class="active">ë‹¤ì´ì•„í† ë‹‰</button>
    <button id="modeMajor">ë©”ì´ì €</button>
  </div>

  <div class="piano" id="piano"></div>

  <script>
    const baseURL = "https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM/acoustic_grand_piano-mp3/";
    const allNotes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const semitoneMap = { "C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11 };

    let audioCtx;
    const audioBuffers = {};
    let currentKey = "C";
    let scaleType = "major";
    let mode = "diatonic";
    let octaves = 2;
    let isReady = false;

    const mapNoteToFile = n => n.replace("#", "s");
    const getNoteURL = (n, o) => `${baseURL}${mapNoteToFile(n)}${o}.mp3`;

    async function loadNote(note, octave) {
      const res = await fetch(getNoteURL(note, octave));
      const buf = await res.arrayBuffer();
      audioBuffers[`${note}${octave}`] = await audioCtx.decodeAudioData(buf);
    }

    async function preloadAll() {
      const tasks = [];
      for (let o = 3; o < 3 + octaves; o++) {
        for (const n of allNotes) tasks.push(loadNote(n, o));
      }
      await Promise.all(tasks);
      isReady = true;
      console.log("âœ… ëª¨ë“  ìŒ ë¡œë“œ ì™„ë£Œ");
    }

    function playSound(note, octave) {
      if (!isReady) return;
      const key = `${note}${octave}`;
      const buffer = audioBuffers[key];
      if (!buffer) return;
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(audioCtx.destination);
      src.start();
    }

    function getMajorChord(root) {
      const i = semitoneMap[root];
      return [root, allNotes[(i+4)%12], allNotes[(i+7)%12]];
    }

    function getScale(key, type) {
      const major = [2,2,1,2,2,2,1];
      const minor = [2,1,2,2,1,2,2];
      const pattern = type==="minor"?minor:major;
      let i = semitoneMap[key];
      const scale=[key];
      for (let p of pattern) {
        i=(i+p)%12; scale.push(allNotes[i]);
      }
      return scale.slice(0,7);
    }

    function getDiatonicChord(root, key, type){
      const scale=getScale(key,type);
      const idx=scale.indexOf(root);
      if(idx===-1) return getMajorChord(root);
      return [root, scale[(idx+2)%scale.length], scale[(idx+4)%scale.length]];
    }

    function playChord(el){
      const noteFull=el.dataset.note;
      const note=noteFull.slice(0,-1);
      const octave=parseInt(noteFull.slice(-1));
      const chord=(mode==="major")?getMajorChord(note):getDiatonicChord(note,currentKey,scaleType);

      chord.forEach((n,i)=>{
        const r=semitoneMap[note], ni=semitoneMap[n]; 
        let o=octave;
        if(ni<r && i!==0) o+=1;
        playSound(n,o);
      });

      highlightChord(chord,note);
    }

    function highlightChord(chord, root){
      document.querySelectorAll(".white-key,.black-key").forEach(k=>k.classList.remove("highlight-root","highlight-chord"));
      chord.forEach(n=>{
        document.querySelectorAll(`[data-note^="${n}"]`).forEach(k=>{
          if(n===root)k.classList.add("highlight-root");
          else k.classList.add("highlight-chord");
        });
      });
      setTimeout(()=>{
        document.querySelectorAll(".highlight-root,.highlight-chord").forEach(k=>k.classList.remove("highlight-root","highlight-chord"));
      },700);
    }

    function createPiano(){
      const piano=document.getElementById("piano");
      piano.innerHTML="";
      const whiteNotes=["C","D","E","F","G","A","B"];
      const blackOffsets={"C#":45,"D#":105,"F#":225,"G#":285,"A#":345};
      let whiteCount=0;

      for(let o=3;o<3+octaves;o++){
        for(const wn of whiteNotes){
          const key=document.createElement("div");
          key.className="white-key";
          key.dataset.note=`${wn}${o}`;
          piano.appendChild(key);
          whiteCount++;
        }
        for(const [bn,left] of Object.entries(blackOffsets)){
          const key=document.createElement("div");
          key.className="black-key";
          key.dataset.note=`${bn}${o}`;
          key.style.left=`${left+(whiteCount-7)*60}px`;
          piano.appendChild(key);
        }
      }

      document.querySelectorAll(".white-key,.black-key").forEach(k=>{
        k.addEventListener("click",()=>playChord(k));
      });
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—°ê²°
    document.getElementById("keySelect").addEventListener("change", e => currentKey = e.target.value);
    document.getElementById("scaleMajor").addEventListener("click", e => {
      scaleType = "major";
      e.target.classList.add("active");
      document.getElementById("scaleMinor").classList.remove("active");
    });
    document.getElementById("scaleMinor").addEventListener("click", e => {
      scaleType = "minor";
      e.target.classList.add("active");
      document.getElementById("scaleMajor").classList.remove("active");
    });
    document.getElementById("modeDiatonic").addEventListener("click", e => {
      mode = "diatonic";
      e.target.classList.add("active");
      document.getElementById("modeMajor").classList.remove("active");
    });
    document.getElementById("modeMajor").addEventListener("click", e => {
      mode = "major";
      e.target.classList.add("active");
      document.getElementById("modeDiatonic").classList.remove("active");
    });
    document.getElementById("octaveSelect").addEventListener("change", e => {
      octaves = parseInt(e.target.value);
      createPiano();
      preloadAll();
    });

    // ì‹œì‘ ë²„íŠ¼
    document.getElementById("startButton").addEventListener("click", async ()=>{
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      await audioCtx.resume();
      document.getElementById("startButton").style.display="none";
      document.getElementById("controls").style.display="flex";
      document.getElementById("piano").style.display="flex";
      createPiano();
      await preloadAll();
      alert("ğŸ¹ í”¼ì•„ë…¸ ì¤€ë¹„ ì™„ë£Œ! ì´ì œ ì—°ì£¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    });
  </script>
</body>
</html>