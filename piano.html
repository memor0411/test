<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì‹¤ì „ ê°€ìƒ í”¼ì•„ë…¸ (WebAudio, ë‹¤ì¤‘ CDN í´ë°±)</title>
<style>
  body{background:#222;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;user-select:none}
  h1{margin-bottom:8px}
  #startButton{padding:10px 18px;background:#4caf50;border:none;border-radius:6px;color:#fff;font-size:16px;cursor:pointer}
  .controls{display:none;gap:12px;margin:12px 0}
  select,button{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
  button.active{background:#4caf50;color:white}
  .piano{display:none;position:relative;height:250px}
  .white-key{width:60px;height:250px;background:#fff;border:1px solid #000;box-shadow:inset -2px 0 3px rgba(0,0,0,.25);display:inline-block;position:relative;vertical-align:top;cursor:pointer}
  .black-key{position:absolute;width:40px;height:160px;background:#000;z-index:2;border-radius:0 0 4px 4px;cursor:pointer}
  .note-label{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);font-size:12px;color:#333}
  .highlight-root{box-shadow:0 0 14px 5px rgba(255,200,0,0.9)}
  .highlight-chord{box-shadow:0 0 10px 4px rgba(100,200,255,0.7)}
  #status{margin-top:8px;height:20px;font-size:13px;color:#ffd}
  #errorList{margin-top:8px;color:#f88;font-size:13px;max-width:760px;text-align:center}
</style>
</head>
<body>
  <h1>ğŸ¹ ê°€ìƒ í”¼ì•„ë…¸ (ì•ˆì • ì¬ìƒ ëª¨ë“œ)</h1>
  <button id="startButton">ğŸµ í”¼ì•„ë…¸ ì‹œì‘í•˜ê¸°</button>

  <div class="controls" id="controls">
    <label>ì˜¥íƒ€ë¸Œ:
      <select id="octaveSelect"><option value="2">2 ì˜¥íƒ€ë¸Œ</option><option value="3">3 ì˜¥íƒ€ë¸Œ</option></select>
    </label>

    <label>ì¡°ì„±:
      <select id="keySelect"><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>A</option><option>B</option></select>
    </label>

    <label>ìŒê³„:
      <button id="scaleMajor" class="active">ì¥ì¡°</button>
      <button id="scaleMinor">ë‹¨ì¡°</button>
    </label>

    <label>ì½”ë“œ:
      <button id="modeDiatonic" class="active">ë‹¤ì´ì•„í† ë‹‰</button>
      <button id="modeMajor">ë©”ì´ì €</button>
    </label>
  </div>

  <div id="status">ë²„í¼ ì¤€ë¹„ ì „ â€” ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
  <div id="errorList"></div>
  <div class="piano" id="piano"></div>

<script>
/* ========= ì„¤ì • ========= */
const candidateBases = [
  // FluidR3_GM mirrored (ë§ì´ ì‚¬ìš©ë˜ëŠ” ê²½ë¡œ)
  "https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM/acoustic_grand_piano-mp3/",
  // salamander / audio-samples íŒ¨í‚¤ì§€ í›„ë³´ë“¤ (jsdelivr npm paths)
  "https://cdn.jsdelivr.net/npm/@audio-samples/piano-mp3-release@1.0.5/",
  "https://cdn.jsdelivr.net/npm/@audio-samples/piano-velocity15@1.0.5/",
  // fallback: another repo (fuhton/piano-mp3) raw link (may 404)
  "https://raw.githubusercontent.com/fuhton/piano-mp3/master/piano-mp3/",
];

const allNotes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const semitoneMap = { "C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11 };

/* ========= ì „ì—­ ìƒíƒœ ========= */
let audioCtx = null;
let audioBuffers = {}; // key: "C4" -> AudioBuffer
let octaves = 2;
let currentKey = "C";
let scaleType = "major"; // major | minor
let mode = "diatonic"; // diatonic | major
let isReady = false;
const failedFiles = new Set();

/* ========= ìœ í‹¸: map note -> íŒŒì¼ëª… =========
   ì—¬ëŸ¬ CDNì€ íŒŒì¼ëª… ê·œì¹™ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ:
   - FluidR3 uses "Cs4.mp3" (s for sharp) in many mirrors
   - some packages use "C#4.mp3" (rare)
   We'll try both patterns for each base.
*/
function fileCandidates(note, octave) {
  const s = note.replace("#","s");        // Fs -> Fs4.mp3
  const sharp = note + octave;            // F#4
  const sname = s + octave;               // Fs4
  return [sname, sharp];
}

/* ========= UI helpers ========= */
const statusEl = document.getElementById("status");
const errorListEl = document.getElementById("errorList");

function setStatus(text) { statusEl.textContent = text; }
function reportError(msg) {
  failedFiles.add(msg);
  errorListEl.innerHTML = Array.from(failedFiles).slice(-5).join(" | ");
}

/* ========= íŒŒì¼ ë¡œë“œ ë¡œì§: í›„ë³´ baseë“¤ì˜ ê° íŒŒì¼ëª…ì„ ì‹œë„í•´ì„œ ì„±ê³µí•œ ì²«ë²ˆì§¸ ì‚¬ìš© ========= */
async function tryLoadSingle(note, octave) {
  const keys = fileCandidates(note, octave); // ["Fs4","F#4"]
  // for each base URL, for each filename candidate
  for (const base of candidateBases) {
    for (const name of keys) {
      const url = base + name + ".mp3";
      try {
        const res = await fetch(url);
        if (!res.ok) {
          // try next
          continue;
        }
        const arr = await res.arrayBuffer();
        const buffer = await audioCtx.decodeAudioData(arr.slice(0));
        audioBuffers[`${note}${octave}`] = buffer;
        console.log("Loaded:", note + octave, "from", url);
        return true;
      } catch (err) {
        // fetch or decode error, try next
        // console.warn("tryLoad failed:", url, err);
        continue;
      }
    }
  }
  // none succeeded
  reportError(`ì‹¤íŒ¨: ${note}${octave}`);
  return false;
}

/* ========= ì „ì²´ ì‚¬ì „ ë¡œë“œ ========= */
async function preloadAll() {
  setStatus("ë¡œë”© ì¤‘... (ìŒì› ë‹¤ìš´ë¡œë“œ ë° ë””ì½”ë”©)");
  audioBuffers = {};
  failedFiles.clear();
  errorListEl.textContent = "";
  const tasks = [];
  for (let o = 3; o < 3 + octaves; o++) {
    for (const n of allNotes) {
      tasks.push(tryLoadSingle(n, o));
    }
  }
  // run with concurrency (batch) to avoid too many parallel fetches
  const batchSize = 8;
  for (let i = 0; i < tasks.length; i += batchSize) {
    const chunk = tasks.slice(i, i + batchSize);
    await Promise.all(chunk.map(p => p));
    setStatus(`ë¡œë”© ì§„í–‰: ${Math.min(i+batchSize, tasks.length)}/${tasks.length}`);
  }
  const loadedCount = Object.keys(audioBuffers).length;
  if (loadedCount === 0) {
    setStatus("ì˜¤ë¥˜: ì–´ë–¤ ìŒì›ë„ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸.");
  } else {
    setStatus(`ì¤€ë¹„ ì™„ë£Œ: ${loadedCount}ê°œ ìŒì› ë¡œë“œë¨. (ì¼ë¶€ ì‹¤íŒ¨ ì‹œ í™”ë©´ì— í‘œì‹œ)`);
  }
  isReady = true;
}

/* ========= ì¬ìƒ ========= */
function playSound(note, octave) {
  if (!isReady) return;
  const key = `${note}${octave}`;
  const buffer = audioBuffers[key];
  if (!buffer) {
    // ë¯¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨í•œ ìŒì´ë©´ ì½˜ì†”ë¡œ ê²½ê³ , í™”ë©´ì—ë„ í‘œì‹œ
    console.warn("Missing buffer for", key);
    reportError(`missing: ${key}`);
    return;
  }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
}

/* ========= ìŠ¤ì¼€ì¼/ì½”ë“œ ìƒì„± ========= */
function getMajorChord(root) {
  const i = semitoneMap[root];
  return [root, allNotes[(i+4)%12], allNotes[(i+7)%12]];
}
function getScale(key, type) {
  const major = [2,2,1,2,2,2,1];
  const minor = [2,1,2,2,1,2,2];
  const pat = type === "minor" ? minor : major;
  let i = semitoneMap[key];
  const arr = [key];
  for (let p of pat) { i = (i+p)%12; arr.push(allNotes[i]); }
  return arr.slice(0,7);
}
function getDiatonicChord(root, key, type){
  const scale = getScale(key, type);
  const idx = scale.indexOf(root);
  if (idx === -1) return getMajorChord(root);
  return [ root, scale[(idx+2)%scale.length], scale[(idx+4)%scale.length] ];
}

/* ========= UI: í”¼ì•„ë…¸ ìƒì„± & í•˜ì´ë¼ì´íŠ¸ ========= */
function createPianoDom() {
  const piano = document.getElementById("piano");
  piano.innerHTML = "";
  const whiteNotes = ["C","D","E","F","G","A","B"];
  const blackNotes = ["C#","D#", null, "F#","G#","A#", null];
  for (let o = 3; o < 3 + octaves; o++) {
    const group = document.createElement("div");
    group.style.display = "inline-block";
    group.style.position = "relative";
    // white keys
    whiteNotes.forEach((wn, i) => {
      const w = document.createElement("div");
      w.className = "white-key";
      w.dataset.note = `${wn}${o}`;
      w.innerHTML = `<div class="note-label">${wn}${o}</div>`;
      w.addEventListener("click", ()=>onKeyClick(w));
      group.appendChild(w);
    });
    // black keys (absolutely positioned inside the group)
    blackNotes.forEach((bn, i) => {
      if (!bn) return;
      const b = document.createElement("div");
      b.className = "black-key";
      b.dataset.note = `${bn}${o}`;
      // position: between white keys: offset = (i+1)*60 - 20 (approx)
      b.style.left = `${(i+1)*60 - 20}px`;
      b.innerHTML = `<div class="note-label">${bn}${o}</div>`;
      b.addEventListener("click", ()=>onKeyClick(b));
      group.appendChild(b);
    });
    piano.appendChild(group);
  }
  document.querySelectorAll(".white-key, .black-key").forEach(k=>{
    k.style.userSelect = "none";
  });
}

function highlightChord(chord, root) {
  document.querySelectorAll(".white-key,.black-key").forEach(k=>{
    k.classList.remove("highlight-root","highlight-chord");
  });
  chord.forEach(n=>{
    document.querySelectorAll(`[data-note^="${n}"]`).forEach(k=>{
      if (n === root) k.classList.add("highlight-root"); else k.classList.add("highlight-chord");
    });
  });
  setTimeout(()=>document.querySelectorAll(".highlight-root,.highlight-chord").forEach(k=>k.classList.remove("highlight-root","highlight-chord")),700);
}

/* ========= í´ë¦­(ë˜ëŠ” í‚¤ë³´ë“œ) ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ========= */
function onKeyClick(el) {
  const noteFull = el.dataset.note;
  const note = noteFull.slice(0,-1);
  const octaveNum = parseInt(noteFull.slice(-1),10);
  let chord = mode === "major" ? getMajorChord(note) : getDiatonicChord(note, currentKey, scaleType);
  // ì¬ìƒ: ì˜¥íƒ€ë¸Œ ë³´ì • (ê°„ë‹¨í•œ ë°©ë²•: if chord tone semitone < root semitone then +1 octave)
  const rootIdx = semitoneMap[note];
  chord.forEach((n,i) => {
    const nIdx = semitoneMap[n];
    let oct = octaveNum;
    if (i !== 0 && nIdx < rootIdx) oct += 1;
    playSound(n, oct);
  });
  highlightChord(chord, note);
  setStatus(`${noteFull} â†’ ${chord.join(" - ")}`);
}

/* ========= ì‹œì‘ ë²„íŠ¼: AudioContext í™œì„±í™” + preload ì‹œì‘ ========= */
document.getElementById("startButton").addEventListener("click", async ()=>{
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();
  } catch(e) {
    alert("AudioContext ìƒì„± ì‹¤íŒ¨: " + e);
    console.error(e);
    return;
  }

  // UI í† ê¸€
  document.getElementById("startButton").style.display="none";
  document.getElementById("controls").style.display="flex";
  document.getElementById("piano").style.display="block";

  // DOM í”¼ì•„ë…¸ ë§Œë“¤ê¸°
  createPianoDom();

  // preload
  await preloadAll();
});

/* ========= ì»¨íŠ¸ë¡¤ ë°” ì´ë²¤íŠ¸ ë°”ì¸ë”© ========= */
document.getElementById("octaveSelect").addEventListener("change", (e)=>{
  octaves = parseInt(e.target.value,10);
  createPianoDom();
  // ì¬ë¡œë“œ
  isReady = false;
  preloadAll();
});
document.getElementById("keySelect").addEventListener("change", (e)=> currentKey = e.target.value);
document.getElementById("scaleMajor").addEventListener("click",(e)=>{ scaleType="major"; e.target.classList.add("active"); document.getElementById("scaleMinor").classList.remove("active"); });
document.getElementById("scaleMinor").addEventListener("click",(e)=>{ scaleType="minor"; e.target.classList.add("active"); document.getElementById("scaleMajor").classList.remove("active"); });
document.getElementById("modeDiatonic").addEventListener("click",(e)=>{ mode="diatonic"; e.target.classList.add("active"); document.getElementById("modeMajor").classList.remove("active"); });
document.getElementById("modeMajor").addEventListener("click",(e)=>{ mode="major"; e.target.classList.add("active"); document.getElementById("modeDiatonic").classList.remove("active"); });

</script>
</body>
</html>
