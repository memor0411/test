<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ê°€ìƒ í”¼ì•„ë…¸ â€” ì•ˆì • ì¬ìƒ & F# ê³ ì •</title>
<style>
  :root { --white-w: 60px; --white-h: 250px; --black-w: 40px; --black-h: 160px; }
  body{background:#222;color:#fff;font-family:system-ui,Segoe UI,Roboto;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:24px;min-height:100vh;box-sizing:border-box}
  h1{margin:0 0 12px}
  #startButton{padding:10px 18px;background:#4caf50;border:0;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}
  #controls{display:none;margin:12px 0;gap:10px;align-items:center}
  select, button.control{padding:6px 10px;border-radius:6px;border:0;background:#eee;color:#111;cursor:pointer}
  button.control.active{background:#4caf50;color:#fff}
  #status{margin-top:8px;color:#ffd;}
  /* piano layout */
  #pianoWrap{display:none;margin-top:14px;position:relative;user-select:none}
  .white-key{width:var(--white-w);height:var(--white-h);background:#fff;border:1px solid #000;box-sizing:border-box;display:inline-block;vertical-align:top;position:relative;cursor:pointer}
  .black-key{position:absolute;width:var(--black-w);height:var(--black-h);background:#000;border-radius:0 0 6px 6px;z-index:2;cursor:pointer}
  .note-label{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);font-size:12px;color:#333}
  .highlight-root{box-shadow:0 0 14px 6px rgba(255,200,0,0.95)}
  .highlight-chord{box-shadow:0 0 10px 5px rgba(100,200,255,0.85)}
  #errors{margin-top:10px;color:#f88;max-width:900px;text-align:center;font-size:13px}
</style>
</head>
<body>
  <h1>ğŸ¹ ê°€ìƒ í”¼ì•„ë…¸ (F#Â·ê²€ì€í‚¤ Â·ë™ì‹œ ì¬ìƒ ìˆ˜ì •)</h1>
  <button id="startButton">ğŸµ í”¼ì•„ë…¸ ì‹œì‘í•˜ê¸°</button>

  <div id="controls">
    <label>ì˜¥íƒ€ë¸Œ:
      <select id="octaveSelect"><option value="2">2 ì˜¥íƒ€ë¸Œ</option><option value="3">3 ì˜¥íƒ€ë¸Œ</option></select>
    </label>

    <label>ì¡°ì„±:
      <select id="keySelect"><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>A</option><option>B</option></select>
    </label>

    <label>ìŒê³„:
      <button id="scaleMajor" class="control active">ì¥ì¡°</button>
      <button id="scaleMinor" class="control">ë‹¨ì¡°</button>
    </label>

    <label>ì½”ë“œ:
      <button id="modeDiatonic" class="control active">ë‹¤ì´ì•„í† ë‹‰</button>
      <button id="modeMajor" class="control">ë©”ì´ì €</button>
    </label>
  </div>

  <div id="status">ë²„í¼ ì¤€ë¹„ ì „ â€” ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
  <div id="errors"></div>

  <div id="pianoWrap"><div id="piano"></div></div>

<script>
/* ================== ì„¤ì • ================== */
const BASE_PRIORITY = [
  "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_grand_piano-mp3/",
  "https://raw.githubusercontent.com/gleitz/midi-js-soundfonts/gh-pages/FluidR3_GM/acoustic_grand_piano-mp3/",
  "https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM/acoustic_grand_piano-mp3/"
];
const ALL_NOTES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const SEMI = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};
/* ========================================== */

let audioCtx = null;
let audioBuffers = {}; // key: "C4" -> AudioBuffer
let octaves = 2;
let currentKey = "C";
let scaleType = "major"; // major | minor
let mode = "diatonic"; // diatonic | major
let isReady = false;
const failedLoads = new Set();
const statusEl = document.getElementById("status");
const errorsEl = document.getElementById("errors");

function setStatus(text){ statusEl.textContent = text; }
function reportError(text){ failedLoads.add(text); errorsEl.textContent = Array.from(failedLoads).slice(-6).join("  |  "); }

/* convert note name to filename used by these repos (Fs vs F#) */
function noteToFileName(note){ return note.replace("#","s"); } // e.g. F# -> Fs

/* Try to load a single note from multiple base URLs (first-success) */
async function tryLoadBuffer(note, octave){
  const key = `${note}${octave}`;
  if (audioBuffers[key]) return true;
  for (const base of BASE_PRIORITY){
    const filename = `${noteToFileName(note)}${octave}.mp3`;
    const url = base + filename;
    try{
      const res = await fetch(url);
      if (!res.ok) { continue; }
      const arr = await res.arrayBuffer();
      const buf = await audioCtx.decodeAudioData(arr.slice(0));
      audioBuffers[key] = buf;
      console.log("Loaded", key, "from", url);
      return true;
    }catch(e){
      // try next base
      // console.warn("load fail", url, e);
      continue;
    }
  }
  reportError(`ë¡œë“œ ì‹¤íŒ¨: ${key}`);
  return false;
}

/* Preload all needed notes (concurrent with limit) */
async function preloadAll(){
  setStatus("ìŒì› ë¡œë“œ ì¤‘... (ì´ ì‘ì—…ì´ ëë‚˜ì•¼ ì†Œë¦¬ê°€ ì •ìƒ ì¬ìƒë©ë‹ˆë‹¤)");
  audioBuffers = {};
  failedLoads.clear();
  errorsEl.textContent = "";
  const tasks = [];
  for (let o = 3; o < 3 + octaves; o++){
    for (const n of ALL_NOTES) tasks.push(() => tryLoadBuffer(n, o));
  }
  // concurrency limit
  const concurrency = 8;
  const results = [];
  for (let i=0; i<tasks.length; i+=concurrency){
    const batch = tasks.slice(i,i+concurrency).map(f => f());
    await Promise.all(batch);
    setStatus(`ë¡œë”© ì§„í–‰: ${Math.min(i+concurrency, tasks.length)}/${tasks.length}`);
  }
  isReady = true;
  setStatus(`ë¡œë“œ ì™„ë£Œ â€” ì¤€ë¹„ë¨. (${Object.keys(audioBuffers).length}ê°œ ë²„í¼)`);
}

/* Create and play from AudioBuffer */
function playFromBuffer(note, octave){
  const key = `${note}${octave}`;
  const buf = audioBuffers[key];
  if (!buf){
    reportError(`ë²„í¼ ì—†ìŒ: ${key}`);
    return;
  }
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  src.connect(audioCtx.destination);
  src.start();
}

/* Scale / chord helpers */
function getMajorChord(root){ const i = SEMI[root]; return [root, ALL_NOTES[(i+4)%12], ALL_NOTES[(i+7)%12]]; }
function getScale(key, type){
  const majorPat=[2,2,1,2,2,2,1], minorPat=[2,1,2,2,1,2,2];
  const pat = type==="minor"?minorPat:majorPat;
  let i = SEMI[key]; const scale=[key];
  for (const step of pat){ i=(i+step)%12; scale.push(ALL_NOTES[i]); }
  return scale.slice(0,7);
}
function getDiatonicChord(root, key, type){
  const scale = getScale(key,type); const idx = scale.indexOf(root);
  if (idx === -1) return getMajorChord(root);
  return [root, scale[(idx+2)%scale.length], scale[(idx+4)%scale.length]];
}

/* Highlight visuals */
function highlightChord(chord, root){
  document.querySelectorAll(".white-key, .black-key").forEach(k => k.classList.remove("highlight-root","highlight-chord"));
  chord.forEach(note => {
    document.querySelectorAll(`[data-note^="${note}"]`).forEach(k => {
      if (note === root) k.classList.add("highlight-root");
      else k.classList.add("highlight-chord");
    });
  });
  setTimeout(()=> document.querySelectorAll(".highlight-root, .highlight-chord").forEach(k=>k.classList.remove("highlight-root","highlight-chord")), 700);
}

/* On-key click (async to allow on-demand loading fallback) */
async function onKeyClicked(el){
  const noteFull = el.dataset.note;
  const root = noteFull.slice(0,-1);
  let octaveNum = parseInt(noteFull.slice(-1),10);
  const chord = mode === "major" ? getMajorChord(root) : getDiatonicChord(root, currentKey, scaleType);

  // Ensure buffers exist (try to load on-demand if missing)
  for (let i=0;i<chord.length;i++){
    const n = chord[i];
    // octave calc: if tone < root semitone (and not root) then raise octave
    const rootIdx = SEMI[root], nIdx = SEMI[n];
    let oct = octaveNum;
    if (i !== 0 && nIdx < rootIdx) oct += 1;

    const key = `${n}${oct}`;
    if (!audioBuffers[key]){
      // attempt to load immediately (tryLoadBuffer uses audioCtx and BASE_PRIORITY)
      await tryLoadBuffer(n, oct);
    }
  }

  // play all chord tones now (simultaneously)
  chord.forEach((n,i)=>{
    const rootIdx = SEMI[root], nIdx = SEMI[n];
    let oct = octaveNum;
    if (i !== 0 && nIdx < rootIdx) oct += 1;
    // if buffer missing still, skip but it's already attempted above
    if (audioBuffers[`${n}${oct}`]) playFromBuffer(n, oct);
  });

  highlightChord(chord, root);
  setStatus(`${noteFull} â†’ ${chord.join(' - ')}`);
}

/* Piano DOM correct layout:
   - white keys appended sequentially (width * count)
   - black keys absolutely positioned over container with computed left offsets
*/
function createPiano(){
  const piano = document.getElementById("piano");
  piano.innerHTML = "";
  const whiteNotes = ["C","D","E","F","G","A","B"];
  const blackNotes = ["C#","D#", null, "F#","G#","A#", null];

  const totalWhite = whiteNotes.length * octaves;
  const totalWidth = totalWhite * 60;
  const container = document.getElementById("pianoWrap");
  const pianoEl = document.getElementById("piano");
  pianoEl.style.width = totalWidth + "px";
  pianoEl.style.position = "relative";
  // add white keys in order
  for (let o=0; o<octaves; o++){
    const octaveNum = 3 + o;
    for (let i=0;i<whiteNotes.length;i++){
      const n = whiteNotes[i];
      const idx = o*7 + i; // absolute white index
      const div = document.createElement("div");
      div.className = "white-key";
      div.style.left = (idx * 60) + "px";
      // make them inline-block visually; we want absolute-free flow so append differently:
      // instead, append normal and use flow - simpler: append inline-block
      // We'll append using inline flow; to keep absolute-coords consistent, use position:relative on parent
      div.style.position = "absolute";
      div.style.top = "0";
      div.style.boxSizing = "border-box";
      div.dataset.note = `${n}${octaveNum}`;
      div.innerHTML = `<div class="note-label">${n}${octaveNum}</div>`;
      div.addEventListener("click", ()=> onKeyClicked(div));
      pianoEl.appendChild(div);
    }
  }
  // add black keys positioned between white keys
  // for each octave, black between: C#/D# -> offsets (0,1), etc.
  for (let o=0; o<octaves; o++){
    const octaveNum = 3 + o;
    for (let i=0;i<blackNotes.length;i++){
      const bn = blackNotes[i];
      if (!bn) continue;
      const whiteIndex = o*7 + i; // black sits after whiteIndex-th white key
      const left = (whiteIndex * 60) + 45; // tuned offset
      const b = document.createElement("div");
      b.className = "black-key";
      b.style.left = left + "px";
      b.style.top = "0px";
      b.dataset.note = `${bn}${octaveNum}`;
      b.innerHTML = `<div class="note-label">${bn}${octaveNum}</div>`;
      b.addEventListener("click", ()=> onKeyClicked(b));
      pianoEl.appendChild(b);
    }
  }
}

/* ========== start button handler ========== */
document.getElementById("startButton").addEventListener("click", async () => {
  // create/resume audio context on user gesture
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();
  }catch(e){
    alert("ë¸Œë¼ìš°ì €ì—ì„œ AudioContext ìƒì„± ì‹¤íŒ¨: " + e);
    console.error(e);
    return;
  }

  // show controls + piano
  document.getElementById("startButton").style.display = "none";
  document.getElementById("controls").style.display = "flex";
  document.getElementById("pianoWrap").style.display = "block";

  // create piano DOM and preload all files
  createPiano();
  setStatus("ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ë¨ â€” ìŒì› ë¡œë“œ ì‹œì‘");
  await preloadAll();
});

/* ========== control bindings ========== */
document.getElementById("octaveSelect").addEventListener("change", async (e)=>{
  octaves = parseInt(e.target.value,10);
  createPiano();
  isReady = false;
  await preloadAll();
});
document.getElementById("keySelect").addEventListener("change", e => currentKey = e.target.value);
document.getElementById("scaleMajor").addEventListener("click", e => {
  scaleType = "major"; e.target.classList.add("active"); document.getElementById("scaleMinor").classList.remove("active");
});
document.getElementById("scaleMinor").addEventListener("click", e => {
  scaleType = "minor"; e.target.classList.add("active"); document.getElementById("scaleMajor").classList.remove("active");
});
document.getElementById("modeDiatonic").addEventListener("click", e => {
  mode = "diatonic"; e.target.classList.add("active"); document.getElementById("modeMajor").classList.remove("active");
});
document.getElementById("modeMajor").addEventListener("click", e => {
  mode = "major"; e.target.classList.add("active"); document.getElementById("modeDiatonic").classList.remove("active");
});
</script>
</body>
</html>
