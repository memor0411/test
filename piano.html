<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ê°€ìƒ í”¼ì•„ë…¸ (Web Audio API)</title>
<style>
  body {
    background: #222;
    color: #fff;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
  }
  #startButton { padding:10px 20px; background:#4caf50; border:none; border-radius:8px; color:white; font-size:16px; cursor:pointer; }
  .controls { display:none; gap:10px; margin:12px 0; }
  select, button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  button.active { background:#4caf50; color:white; }
  .piano { display:none; position:relative; height:250px; }
  .white-key { width:60px; height:250px; background:white; border:1px solid black; box-shadow:inset -2px 0 3px rgba(0,0,0,0.25); display:inline-block; position:relative; cursor:pointer; }
  .black-key { position:absolute; width:40px; height:160px; background:black; z-index:2; border-radius:0 0 4px 4px; cursor:pointer; }
  .note-label { position:absolute; left:50%; bottom:8px; transform:translateX(-50%); font-size:12px; color:#333; }
  .highlight-root { box-shadow:0 0 15px 5px rgba(255, 220, 50, 0.9); }
  .highlight-chord { box-shadow:0 0 10px 4px rgba(100, 200, 255, 0.8); }
</style>
</head>
<body>
  <h1>ğŸ¹ ê°€ìƒ í”¼ì•„ë…¸ (ì‹¤ì œ ìŒì› ì‘ë™ ë²„ì „)</h1>
  <button id="startButton">ğŸµ í”¼ì•„ë…¸ ì‹œì‘í•˜ê¸°</button>

  <div class="controls" id="controls">
    <label>ì˜¥íƒ€ë¸Œ:
      <select id="octaveSelect">
        <option value="2">2 ì˜¥íƒ€ë¸Œ</option>
        <option value="3">3 ì˜¥íƒ€ë¸Œ</option>
      </select>
    </label>
    <label>ì¡°ì„±:
      <select id="keySelect">
        <option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>A</option><option>B</option>
      </select>
    </label>
    <label>ìŒê³„:
      <button id="scaleMajor" class="active">ì¥ì¡°</button>
      <button id="scaleMinor">ë‹¨ì¡°</button>
    </label>
    <label>ì½”ë“œ:
      <button id="modeDiatonic" class="active">ë‹¤ì´ì•„í† ë‹‰</button>
      <button id="modeMajor">ë©”ì´ì €</button>
    </label>
  </div>

  <div id="status">ë²„í¼ ì¤€ë¹„ ì „ â€” "í”¼ì•„ë…¸ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
  <div class="piano" id="piano"></div>

<script>
const BASE_URL = "https://raw.githubusercontent.com/gleitz/midi-js-soundfonts/gh-pages/FluidR3_GM/acoustic_grand_piano-mp3/";
const allNotes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const semitoneMap = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};

let audioCtx;
let audioBuffers = {};
let octaves = 2;
let currentKey = "C";
let scaleType = "major";
let mode = "diatonic";
let isReady = false;

function logStatus(msg){ document.getElementById("status").textContent = msg; }

async function loadAudio(note, octave) {
  const name = note.replace("#","s");
  const url = `${BASE_URL}${name}${octave}.mp3`;
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    const buffer = await audioCtx.decodeAudioData(arr);
    audioBuffers[`${note}${octave}`] = buffer;
  } catch (e) {
    console.warn("ìŒì› ë¡œë“œ ì‹¤íŒ¨:", url, e);
  }
}

async function preloadAll() {
  logStatus("ìŒì› ë¡œë“œ ì¤‘...");
  audioBuffers = {};
  for (let o = 3; o < 3 + octaves; o++) {
    for (const n of allNotes) {
      await loadAudio(n, o);
    }
  }
  isReady = true;
  logStatus("ìŒì› ë¡œë“œ ì™„ë£Œ âœ…");
}

function playSound(note, octave) {
  const key = `${note}${octave}`;
  const buffer = audioBuffers[key];
  if (!buffer) return;
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
}

function getMajorChord(root) {
  const i = semitoneMap[root];
  return [root, allNotes[(i+4)%12], allNotes[(i+7)%12]];
}

function getScale(key, type) {
  const major = [2,2,1,2,2,2,1];
  const minor = [2,1,2,2,1,2,2];
  const pat = type === "minor" ? minor : major;
  let i = semitoneMap[key];
  const arr = [key];
  for (let p of pat) { i = (i+p)%12; arr.push(allNotes[i]); }
  return arr.slice(0,7);
}

function getDiatonicChord(root, key, type){
  const scale = getScale(key, type);
  const idx = scale.indexOf(root);
  if (idx === -1) return getMajorChord(root);
  return [ root, scale[(idx+2)%scale.length], scale[(idx+4)%scale.length] ];
}

function highlightChord(chord, root) {
  document.querySelectorAll(".white-key,.black-key").forEach(k=>{
    k.classList.remove("highlight-root","highlight-chord");
  });
  chord.forEach(n=>{
    document.querySelectorAll(`[data-note^="${n}"]`).forEach(k=>{
      if (n === root) k.classList.add("highlight-root");
      else k.classList.add("highlight-chord");
    });
  });
  setTimeout(()=>document.querySelectorAll(".highlight-root,.highlight-chord")
    .forEach(k=>k.classList.remove("highlight-root","highlight-chord")), 700);
}

function onKeyClick(el) {
  const noteFull = el.dataset.note;
  const note = noteFull.slice(0,-1);
  const octaveNum = parseInt(noteFull.slice(-1));
  let chord = mode === "major" ? getMajorChord(note) : getDiatonicChord(note, currentKey, scaleType);
  const rootIdx = semitoneMap[note];
  chord.forEach((n,i)=>{
    let oct = octaveNum;
    if (i !== 0 && semitoneMap[n] < rootIdx) oct += 1;
    playSound(n, oct);
  });
  highlightChord(chord, note);
  logStatus(`${noteFull} â†’ ${chord.join(" - ")}`);
}

function createPianoDom() {
  const piano = document.getElementById("piano");
  piano.innerHTML = "";
  const whiteNotes = ["C","D","E","F","G","A","B"];
  const blackNotes = ["C#","D#", null, "F#","G#","A#", null];
  for (let o = 3; o < 3 + octaves; o++) {
    const group = document.createElement("div");
    group.style.display = "inline-block";
    group.style.position = "relative";
    whiteNotes.forEach((wn,i)=>{
      const w=document.createElement("div");
      w.className="white-key";
      w.dataset.note=`${wn}${o}`;
      w.innerHTML=`<div class="note-label">${wn}${o}</div>`;
      w.addEventListener("click",()=>onKeyClick(w));
      group.appendChild(w);
    });
    blackNotes.forEach((bn,i)=>{
      if(!bn)return;
      const b=document.createElement("div");
      b.className="black-key";
      b.dataset.note=`${bn}${o}`;
      b.style.left=`${(i+1)*60 - 20}px`;
      b.innerHTML=`<div class="note-label">${bn}${o}</div>`;
      b.addEventListener("click",()=>onKeyClick(b));
      group.appendChild(b);
    });
    piano.appendChild(group);
  }
}

document.getElementById("startButton").addEventListener("click", async ()=>{
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  await audioCtx.resume();
  document.getElementById("startButton").style.display="none";
  document.getElementById("controls").style.display="flex";
  document.getElementById("piano").style.display="block";
  createPianoDom();
  await preloadAll();
});

document.getElementById("octaveSelect").addEventListener("change", e=>{
  octaves = parseInt(e.target.value);
  createPianoDom();
  preloadAll();
});
document.getElementById("keySelect").addEventListener("change", e=>currentKey=e.target.value);
document.getElementById("scaleMajor").addEventListener("click", e=>{
  scaleType="major"; e.target.classList.add("active");
  document.getElementById("scaleMinor").classList.remove("active");
});
document.getElementById("scaleMinor").addEventListener("click", e=>{
  scaleType="minor"; e.target.classList.add("active");
  document.getElementById("scaleMajor").classList.remove("active");
});
document.getElementById("modeDiatonic").addEventListener("click", e=>{
  mode="diatonic"; e.target.classList.add("active");
  document.getElementById("modeMajor").classList.remove("active");
});
document.getElementById("modeMajor").addEventListener("click", e=>{
  mode="major"; e.target.classList.add("active");
  document.getElementById("modeDiatonic").classList.remove("active");
});
</script>
</body>
</html>
